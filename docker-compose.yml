version: '3.8'

services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-demo
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native client port
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./config/users.xml:/etc/clickhouse-server/users.xml
      - ./init-scripts:/docker-entrypoint-initdb.d
    environment:
      CLICKHOUSE_DB: demo_db
      CLICKHOUSE_USER: demo_user
      CLICKHOUSE_PASSWORD: demo_password
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: .
    container_name: clickhouse-demo-app
    ports:
      - "3000:3000"
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 9000
      CLICKHOUSE_USER: demo_user
      CLICKHOUSE_PASSWORD: demo_password
      CLICKHOUSE_DB: demo_db

# Note: Chat service is designed to run locally for better Ollama integration
# To start: source venv/bin/activate && CLICKHOUSE_HOST=localhost python3 chat_service.py
#
#  chat:
#    build:
#      context: .
#      dockerfile: Dockerfile.chat
#    container_name: clickhouse-demo-chat
#    ports:
#      - "5001:5000"
#    depends_on:
#      clickhouse:
#        condition: service_healthy
#    environment:
#      CLICKHOUSE_HOST: clickhouse
#      CLICKHOUSE_PORT: 9000
#      CLICKHOUSE_USER: demo_user
#      CLICKHOUSE_PASSWORD: demo_password
#      CLICKHOUSE_DB: demo_db
#      OLLAMA_HOST: host.docker.internal
#      OLLAMA_PORT: 11434

volumes:
  clickhouse_data:
